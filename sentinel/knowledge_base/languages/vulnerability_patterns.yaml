# Multi-Language Vulnerability Patterns
# Deep knowledge base for non-EVM smart contract languages

languages:

  # ===========================================================================
  # RUST / ANCHOR (SOLANA)
  # ===========================================================================
  rust_anchor:
    name: "Rust (Anchor/Solana)"
    ecosystem: "solana"

    critical_vulnerabilities:
      - id: "SOL-001"
        name: "Missing Signer Check"
        description: "Function accepts authority/admin without requiring signature"
        severity: "critical"
        pattern: "pub authority: AccountInfo<'info> (without Signer)"
        fix: "Use Signer<'info> for accounts requiring authorization"
        frequency: "Very Common"

      - id: "SOL-002"
        name: "Account Confusion / Type Cosplay"
        description: "Raw AccountInfo used without type validation"
        severity: "critical"
        pattern: "AccountInfo<'info> with manual deserialization"
        fix: "Use Account<'info, T> with proper discriminator checks"
        frequency: "Common"

      - id: "SOL-003"
        name: "Missing Owner Check"
        description: "Account owner not validated against program ID"
        severity: "critical"
        pattern: "Using account data without checking owner field"
        fix: "Verify account.owner == program_id or use Account<T>"
        frequency: "Common"

      - id: "SOL-004"
        name: "PDA Seed Collision"
        description: "User-controlled seeds can create colliding PDAs"
        severity: "high"
        pattern: "seeds = [user_input.as_bytes()]"
        fix: "Include unique identifiers (user pubkey) in seeds"
        frequency: "Medium"

    high_vulnerabilities:
      - id: "SOL-005"
        name: "Reinitialization"
        description: "Account can be initialized multiple times"
        severity: "high"
        pattern: "No is_initialized check before init"
        fix: "Use Anchor's init constraint or check is_initialized flag"

      - id: "SOL-006"
        name: "Closing Account Incorrectly"
        description: "Account data not zeroed when closing"
        severity: "high"
        pattern: "Transfer lamports without zeroing data"
        fix: "Use Anchor's close constraint or zero data manually"

      - id: "SOL-007"
        name: "Integer Overflow"
        description: "Arithmetic operations can overflow in release mode"
        severity: "high"
        pattern: "a + b, a * b without checked_"
        fix: "Use checked_add, checked_mul, or overflow-checks = true"

    unique_patterns:
      - "ctx.accounts"
      - "#[account]"
      - "Pubkey"
      - "invoke_signed"
      - "CpiContext"

  # ===========================================================================
  # MOVE (APTOS)
  # ===========================================================================
  move_aptos:
    name: "Move (Aptos)"
    ecosystem: "aptos"

    critical_vulnerabilities:
      - id: "APT-001"
        name: "Missing Signer Validation"
        description: "Signer parameter not checked for authorization"
        severity: "critical"
        pattern: "_account: &signer (underscore prefix, not used)"
        fix: "Always validate signer::address_of(account) == expected"
        frequency: "Common"

      - id: "APT-002"
        name: "Unauthorized Resource Access"
        description: "Accessing resources of other accounts without permission"
        severity: "critical"
        pattern: "borrow_global<T>(arbitrary_address)"
        fix: "Only access caller's resources or implement proper capability checks"
        frequency: "Medium"

      - id: "APT-003"
        name: "Capability Leak"
        description: "Capability struct returned/moved allowing unauthorized use"
        severity: "critical"
        pattern: "public fun get_cap(): Capability"
        fix: "Keep capabilities within module, use inline authorization"
        frequency: "Medium"

    high_vulnerabilities:
      - id: "APT-004"
        name: "Arithmetic Overflow"
        description: "Unchecked arithmetic in sensitive calculations"
        severity: "high"
        pattern: "a + b without bound checks"
        fix: "Check result >= operands for addition"

      - id: "APT-005"
        name: "Flash Loan Abuse"
        description: "Flash loan receipt can be discarded"
        severity: "high"
        pattern: "Returning receipt struct without consumption"
        fix: "Use hot potato pattern - receipt must be consumed"

    unique_patterns:
      - "acquires"
      - "borrow_global"
      - "move_to"
      - "signer::address_of"
      - "coin::Coin"

  # ===========================================================================
  # MOVE (SUI)
  # ===========================================================================
  move_sui:
    name: "Move (Sui)"
    ecosystem: "sui"

    critical_vulnerabilities:
      - id: "SUI-001"
        name: "Shared Object Race Condition"
        description: "Shared objects accessed concurrently with inconsistent state"
        severity: "critical"
        pattern: "Using shared objects without mutex patterns"
        fix: "Implement proper locking or use owned objects"
        frequency: "Medium"

      - id: "SUI-002"
        name: "Object Ownership Confusion"
        description: "Object transferred/shared incorrectly"
        severity: "critical"
        pattern: "transfer::public_transfer vs transfer::transfer misuse"
        fix: "Use correct transfer function based on object type"
        frequency: "Common"

    high_vulnerabilities:
      - id: "SUI-003"
        name: "Missing Capability Check"
        description: "Administrative functions without capability verification"
        severity: "high"
        pattern: "Admin function without AdminCap parameter"
        fix: "Require capability objects for privileged operations"

      - id: "SUI-004"
        name: "Programmable Transaction Block Abuse"
        description: "PTBs enabling flash-loan-like attacks"
        severity: "high"
        pattern: "Functions that can be chained in PTBs for exploitation"
        fix: "Consider PTB context when designing functions"

    unique_patterns:
      - "TxContext"
      - "UID"
      - "transfer::public_transfer"
      - "dynamic_field"
      - "clock::Clock"

  # ===========================================================================
  # CAIRO (STARKNET)
  # ===========================================================================
  cairo:
    name: "Cairo (Starknet)"
    ecosystem: "starknet"

    critical_vulnerabilities:
      - id: "STARK-001"
        name: "Missing Caller Validation"
        description: "No get_caller_address() check for privileged functions"
        severity: "critical"
        pattern: "External function without caller validation"
        fix: "Always check get_caller_address() == expected"
        frequency: "Common"

      - id: "STARK-002"
        name: "L1-L2 Message Spoofing"
        description: "L1 handler doesn't validate sender address"
        severity: "critical"
        pattern: "#[l1_handler] without from_address check"
        fix: "Validate from_address matches trusted L1 contract"
        frequency: "Medium"

    high_vulnerabilities:
      - id: "STARK-003"
        name: "Felt252 Overflow"
        description: "felt252 wraps at prime, different from u256"
        severity: "high"
        pattern: "Arithmetic on felt252 in sensitive calculations"
        fix: "Use u256 for amounts, add overflow checks"

      - id: "STARK-004"
        name: "Reentrancy"
        description: "External call before state update"
        severity: "high"
        pattern: "External call followed by storage write"
        fix: "Use CEI pattern, implement reentrancy guard"

      - id: "STARK-005"
        name: "Signature Malleability"
        description: "Same message can have multiple valid signatures"
        severity: "high"
        pattern: "Using signatures without nonce/replay protection"
        fix: "Include nonce in signed message, track used nonces"

    unique_patterns:
      - "get_caller_address"
      - "felt252"
      - "#[l1_handler]"
      - "@storage_var"
      - "ContractAddress"

  # ===========================================================================
  # VYPER
  # ===========================================================================
  vyper:
    name: "Vyper"
    ecosystem: "evm"

    critical_vulnerabilities:
      - id: "VYP-001"
        name: "Reentrancy Lock Bug (0.2.15-0.3.0)"
        description: "@nonreentrant decorator was broken in these versions"
        severity: "critical"
        pattern: "Vyper version 0.2.15, 0.2.16, or 0.3.0"
        fix: "Upgrade to Vyper >= 0.3.1"
        frequency: "Historical (July 2023 exploits)"
        historical_losses: "$70M+"

    high_vulnerabilities:
      - id: "VYP-002"
        name: "Default Function Issues"
        description: "Default function can receive unexpected calls"
        severity: "high"
        pattern: "@external\\n__default__"
        fix: "Carefully consider default function behavior"

      - id: "VYP-003"
        name: "Raw Call Vulnerabilities"
        description: "raw_call without proper checks"
        severity: "high"
        pattern: "raw_call(target, data)"
        fix: "Validate return value, use max_outsize"

    unique_patterns:
      - "@external"
      - "@nonreentrant"
      - "HashMap"
      - "DynArray"
      - "raw_call"

  # ===========================================================================
  # COSMWASM (RUST)
  # ===========================================================================
  cosmwasm:
    name: "CosmWasm"
    ecosystem: "cosmos"

    critical_vulnerabilities:
      - id: "CW-001"
        name: "Missing Sender Validation"
        description: "info.sender not checked for privileged operations"
        severity: "critical"
        pattern: "ExecuteMsg handler without sender check"
        fix: "Validate info.sender == stored_admin"
        frequency: "Common"

    high_vulnerabilities:
      - id: "CW-002"
        name: "Submessage Reentrancy"
        description: "State inconsistency via SubMsg replies"
        severity: "high"
        pattern: "SubMsg without proper reply handling"
        fix: "Handle all reply cases, maintain consistent state"

      - id: "CW-003"
        name: "Unbounded Iteration"
        description: "Iterating over unbounded storage maps"
        severity: "high"
        pattern: "for item in storage_map.iter()"
        fix: "Implement pagination, use range queries"

      - id: "CW-004"
        name: "Integer Overflow"
        description: "Arithmetic overflow in Uint128/Uint256"
        severity: "high"
        pattern: "a + b without checked_"
        fix: "Use checked_add, handle Overflow error"

    unique_patterns:
      - "ExecuteMsg"
      - "QueryMsg"
      - "Deps"
      - "MessageInfo"
      - "SubMsg"

  # ===========================================================================
  # INK! (POLKADOT)
  # ===========================================================================
  ink:
    name: "Ink! (Polkadot)"
    ecosystem: "polkadot"

    critical_vulnerabilities:
      - id: "INK-001"
        name: "Missing Caller Check"
        description: "self.env().caller() not validated"
        severity: "critical"
        pattern: "#[ink(message)] without caller check"
        fix: "Always validate caller for privileged operations"

    high_vulnerabilities:
      - id: "INK-002"
        name: "Storage Layout Changes"
        description: "Upgrades can corrupt storage"
        severity: "high"
        pattern: "Adding/removing storage fields between versions"
        fix: "Maintain storage layout compatibility"

      - id: "INK-003"
        name: "Cross-Contract Call Issues"
        description: "Calling untrusted contracts"
        severity: "high"
        pattern: "call_builder with user-supplied address"
        fix: "Validate contract addresses, handle failures"

    unique_patterns:
      - "#[ink::contract]"
      - "#[ink(message)]"
      - "#[ink(storage)]"
      - "self.env().caller()"
      - "ink_env"

# ===========================================================================
# CROSS-LANGUAGE PATTERNS
# ===========================================================================
common_patterns:
  access_control:
    description: "All languages require proper authorization checks"
    check_for:
      - "Signer/caller validation"
      - "Admin/owner checks"
      - "Capability/permission verification"

  arithmetic:
    description: "Overflow behavior varies by language"
    variations:
      solidity: "Checked by default (0.8+), wraps pre-0.8"
      rust: "Panics in debug, wraps in release (unless checked_)"
      move: "Can overflow, needs explicit checks"
      cairo: "felt252 wraps at prime, u256 panics"

  reentrancy:
    description: "All languages with external calls need protection"
    patterns:
      - "External call before state update"
      - "Callback functions"
      - "Cross-contract invocations"

  initialization:
    description: "Reinitialization attacks are universal"
    prevention:
      - "Check is_initialized flag"
      - "Use constructor/init_once patterns"
      - "Verify deployer/creator"
