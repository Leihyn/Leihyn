"""Base scanner classes for platform-specific vulnerability detection."""

from dataclasses import dataclass, field
from enum import Enum
from typing import Optional
from pathlib import Path
import re


class VulnerabilitySeverity(Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"


@dataclass
class PlatformVulnerability:
    """A platform-specific vulnerability."""
    pattern_id: str
    name: str
    severity: VulnerabilitySeverity
    file_path: str
    line_number: int
    code_snippet: str
    description: str
    attack_scenario: str
    recommendation: str

    def to_markdown(self) -> str:
        return f"""## [{self.severity.value.upper()}] {self.name}

**Pattern**: {self.pattern_id}
**Location**: `{self.file_path}:{self.line_number}`

**Description**: {self.description}

**Code**:
```
{self.code_snippet}
```

**Attack Scenario**: {self.attack_scenario}

**Recommendation**: {self.recommendation}
"""


@dataclass
class ScanReport:
    """Scan results report."""
    platform: str
    project_path: str
    files_scanned: list[str]
    vulnerabilities: list[PlatformVulnerability]

    @property
    def critical_count(self) -> int:
        return len([v for v in self.vulnerabilities if v.severity == VulnerabilitySeverity.CRITICAL])

    def to_markdown(self) -> str:
        lines = [
            f"# {self.platform.title()} Vulnerability Scan",
            "",
            f"**Files Scanned**: {len(self.files_scanned)}",
            f"**Vulnerabilities Found**: {len(self.vulnerabilities)}",
            f"**Critical**: {self.critical_count}",
            "",
        ]

        for v in sorted(self.vulnerabilities, key=lambda x: x.severity.value):
            lines.append(v.to_markdown())
            lines.append("---")
            lines.append("")

        return "\n".join(lines)


class PlatformScanner:
    """Base class for platform-specific vulnerability scanners."""

    def __init__(self, project_path: str, platform: str = "generic"):
        self.project_path = Path(project_path)
        self.platform = platform

    def scan(self) -> ScanReport:
        """Override in subclasses."""
        return ScanReport(
            platform=self.platform,
            project_path=str(self.project_path),
            files_scanned=[],
            vulnerabilities=[],
        )

    def _get_context(self, content: str, pos: int, lines: int = 5) -> str:
        start = content.rfind('\n', 0, pos)
        for _ in range(lines - 1):
            new_start = content.rfind('\n', 0, start)
            if new_start == -1:
                break
            start = new_start
        end = content.find('\n', pos)
        for _ in range(lines - 1):
            new_end = content.find('\n', end + 1)
            if new_end == -1:
                break
            end = new_end
        return content[start:end].strip()
